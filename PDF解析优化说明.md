# PDF解析优化说明 - 解决行混乱问题

## 📋 问题描述

PDF提取时一行内容被拆分成多行，影响解析准确度。例如：
```
错误提取：
姓
名
：
张
三

正确提取：
姓名：张三
```

## 🎯 解决方案

采用**三级解析+文本修复**策略，通过多方法融合和智能行修复，解决PDF提取的行混乱问题。

## 🔧 实现内容

### 1. 新增智能PDF提取函数

#### `extract_pdf_intelligent(file_path)`
- **功能：** 智能PDF提取主函数
- **策略：**
  1. 尝试三种提取方法（PyMuPDF、pdfplumber、pdfminer）
  2. 选择最佳结果（评分机制）
  3. 修复行混乱问题
- **返回：** 修复后的文本

#### 辅助提取函数

**`extract_with_pymupdf(file_path)`**
- 使用PyMuPDF快速提取
- 适合标准文本PDF

**`extract_with_pdfplumber(file_path)`**
- 使用pdfplumber提取，保持布局
- 适合复杂布局PDF

**`extract_with_pdfminer(file_path)`**
- 使用pdfminer提取，中文优化
- 适合中文文档

### 2. 文本修复函数

#### `repair_line_breaks(text)`
- **功能：** 修复PDF提取的行混乱问题
- **策略：**
  1. 逐行分析
  2. 判断是否需要合并相邻行
  3. 识别完整句子
  4. 合并被错误分割的行

#### 辅助判断函数

**`should_merge(prev_line, current_line)`**
- 判断两行是否应该合并
- 规则：
  - 前一行以标点结束 → 不合并
  - 当前行以标点开头 → 不合并
  - 前一行以空格/短横线结尾 → 合并
  - 前一行太短且以中文结尾 → 合并

**`is_complete_sentence(text)`**
- 判断文本是否是完整句子
- 规则：
  - 以标点结束 → 完整
  - 长度>50且中文字符>10 → 可能是完整段落

**`select_best_result(results)`**
- 从多个提取结果中选择最佳结果
- 评分标准：
  - 文本长度
  - 中文字符数（权重×2）
  - 唯一字符数
  - 中文字符占比

### 3. 更新调用位置

#### `process_resume_async()`
- PDF文件使用 `extract_pdf_intelligent()`
- Word文件使用原有 `extract_text()`

#### `analyze_interview_doc()`
- PDF文件使用 `extract_pdf_intelligent()`
- Word文件使用原有 `extract_text()`

### 4. 依赖更新

**requirements.txt 新增：**
```
pdfminer.six==20221105
```

## 📊 工作流程

```
PDF文件
  ↓
尝试三种提取方法
  ├─ PyMuPDF (快速)
  ├─ pdfplumber (布局保持)
  └─ pdfminer (中文优化)
  ↓
选择最佳结果（评分机制）
  ↓
修复行混乱问题
  ├─ 识别被错误分割的行
  ├─ 合并相邻行
  └─ 保持完整句子
  ↓
返回修复后的文本
```

## 🔍 修复规则示例

### 示例1：中文行分割
```
修复前：
姓
名
：
张
三

修复后：
姓名：张三
```

### 示例2：短行合并
```
修复前：
工作
经历
：
2020
年
至
今

修复后：
工作经历：2020年至今
```

### 示例3：保持完整句子
```
修复前：
我是一名
软件工程师。
具有5年
开发经验。

修复后：
我是一名软件工程师。
具有5年开发经验。
```

## ✅ 优势

1. **多方法融合：** 三种提取方法互补，提高成功率
2. **智能选择：** 自动选择最佳提取结果
3. **行修复：** 智能合并被错误分割的行
4. **保持结构：** 保留段落和句子结构
5. **中文优化：** 针对中文文档优化

## 🧪 测试建议

### 测试用例

1. **标准文本PDF：** 应该使用PyMuPDF，速度快
2. **复杂布局PDF：** 应该使用pdfplumber，保持布局
3. **中文文档PDF：** 应该使用pdfminer，中文优化
4. **行混乱PDF：** 应该正确修复行分割问题

### 测试方法

使用 `/test-parser` 端点测试不同PDF文件，查看：
- 使用的提取方法
- 文本长度和中文字符数
- 修复前后的对比

## 📝 注意事项

1. **性能：** 三种方法都会尝试，可能稍慢，但准确度更高
2. **依赖：** 需要安装 `pdfminer.six`
3. **降级：** 如果某种方法失败，自动使用其他方法
4. **兼容：** Word文件仍使用原有方法，不受影响

## 🔄 后续优化建议

1. **缓存结果：** 对相同文件缓存提取结果
2. **并行提取：** 三种方法并行执行，提高速度
3. **学习优化：** 根据历史数据优化选择策略
4. **自定义规则：** 允许用户自定义行合并规则

---

**实现完成时间：** 2025-01-27  
**版本：** v1.0.0

