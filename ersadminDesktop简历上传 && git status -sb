"""
智能简历数据库系统 - 主应用
"""
from flask import Flask, render_template, request, jsonify, send_file
from werkzeug.utils import secure_filename
import os
import json
from datetime import datetime
from config import Config
from models import get_db_session, Resume, Position
from utils.file_parser import extract_text
from utils.info_extractor import InfoExtractor
from utils.api_integration import APIIntegration
from utils.ai_extractor import AIExtractor
from utils.duplicate_checker import check_duplicate
import threading

app = Flask(__name__, 
            template_folder='templates',
            static_folder='static')
app.config.from_object(Config)

# 初始化OCR引擎（如果启用）
if app.config.get('OCR_ENABLED', True):
    from utils.file_parser import init_ocr_engine
    init_ocr_engine(
        ocr_enabled=app.config.get('OCR_ENABLED', True),
        engine=app.config.get('OCR_ENGINE', 'paddleocr'),
        use_gpu=app.config.get('OCR_USE_GPU', False)
    )

def allowed_file(filename):
    """检查文件扩展名是否允许"""
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in app.config['ALLOWED_EXTENSIONS']

def process_resume_async(resume_id, file_path):
    """异步处理简历解析"""
    db = get_db_session()
    try:
        resume = db.query(Resume).filter_by(id=resume_id).first()
        if not resume:
            return
        
        resume.parse_status = 'processing'
        db.commit()
        
        # 提取文本
        raw_text = extract_text(file_path)
        if not raw_text:
            raise Exception("无法从文件中提取文本，文件可能已损坏或格式不支持")
        
        # 检测文件类型
        file_ext = os.path.splitext(file_path)[1].lower()
        is_word_file = file_ext in ['.doc', '.docx']
        
        # 检查是否启用AI（从配置或请求参数）
        ai_enabled = app.config.get('AI_ENABLED', True)
        ai_api_key = app.config.get('AI_API_KEY', '')
        ai_api_base = app.config.get('AI_API_BASE', '')
        ai_model = app.config.get('AI_MODEL', 'gpt-3.5-turbo')
        
        # 如果配置中没有API密钥，尝试从环境变量获取
        if not ai_api_key:
            ai_api_key = os.environ.get('OPENAI_API_KEY') or os.environ.get('AI_API_KEY') or os.environ.get('DEEPSEEK_API_KEY') or ''
        
        # 如果链接了AI API，优先使用AI优化文本提取
        text = raw_text
        ai_extractor = None
        if ai_enabled and ai_api_key:
            try:
                ai_extractor = AIExtractor(
                    api_key=ai_api_key,
                    api_base=ai_api_base if ai_api_base else None,
                    model=ai_model
                )
                # 使用AI优化文本提取
                optimized_text = ai_extractor.optimize_text_extraction(raw_text)
                if optimized_text:
                    text = optimized_text
                    print(f"AI文本优化成功（模型: {ai_model}），文本长度: {len(text)} 字符")
                else:
                    print(f"AI文本优化失败（模型: {ai_model}），使用原始文本")
            except Exception as e:
                print(f"AI文本优化失败（模型: {ai_model}），使用原始文本: {e}")
        
        # 保存原始文本（优先保存优化后的文本，如果没有优化则保存原始文本）
        # 注意：raw_text字段存储的是用于信息提取的文本（可能是优化后的）
        # 如果需要保存真正的原始文本，可以添加新字段
        resume.raw_text = text
        
        # 如果使用了AI优化，原始文本和优化后的文本都保存
        # 但为了信息提取准确性，使用优化后的文本进行提取
        
        # 规则提取
        extractor = InfoExtractor()
        
        # AI辅助信息提取（如果启用）
        ai_result = None
        if ai_enabled and ai_api_key and ai_extractor:
            try:
                ai_result = ai_extractor.extract_with_ai(text, is_word_file=is_word_file)
                if ai_result:
                    print(f"AI辅助信息提取成功（模型: {ai_model}，Word格式: {is_word_file}），提取到 {len([k for k, v in ai_result.items() if v])} 个字段")
            except Exception as e:
                print(f"AI辅助信息提取失败（模型: {ai_model}），继续使用规则提取: {e}")
        
        # 融合规则提取和AI提取的结果
        info = extractor.extract_all(text, ai_result=ai_result)
        
        # 更新基本信息
        resume.name = info.get('name')
        resume.gender = info.get('gender')
        resume.birth_year = info.get('birth_year')
        # 如果从简历中提取到了年龄，保存到age_from_resume
        extracted_age = info.get('age')
        if extracted_age:
            resume.age_from_resume = extracted_age
            resume.age = extracted_age
        else:
            # 如果没有提取到年龄，但有出生年份，计算年龄
            if resume.birth_year:
                resume.age = datetime.now().year - resume.birth_year
        resume.phone = info.get('phone')
        resume.email = info.get('email')
        resume.highest_education = info.get('highest_education')
        resume.raw_text = text
        resume.error_message = None
        
        # 处理工作经历和公司验证
        work_experiences = info.get('work_experience', [])
        for exp in work_experiences:
            company_name = exp.get('company')
            if company_name:
                standardized, status, confidence, code, alternatives = \
                    APIIntegration.verify_company(company_name)
                if standardized:
                    exp['company_standardized'] = standardized
                    exp['company_code'] = code
                    exp['company_match_status'] = status
                    exp['company_confidence'] = confidence
                    exp['company_alternatives'] = alternatives
        
        resume.work_experience = work_experiences
        
        # 处理学校信息（仅保留原文提取）
        school_original = info.get('school')
        if school_original:
            resume.school = school_original
            resume.school_original = school_original
        
        # 处理专业信息（仅保留原文提取）
        major_original = info.get('major')
        if major_original:
            resume.major = major_original
            resume.major_original = major_original
        
        # 计算并保存最早工作年份
        if work_experiences:
            work_years = [exp.get('start_year') for exp in work_experiences if exp.get('start_year')]
            if work_years:
                resume.earliest_work_year = min(work_years)
        
        # 查重检测
        existing_resumes = db.query(Resume).filter(
            Resume.parse_status == 'success',
            Resume.id != resume.id
        ).all()
        duplicate_id, similarity = check_duplicate(resume, existing_resumes)
        
        if similarity >= 80.0:
            resume.duplicate_status = '重复简历'
            resume.duplicate_similarity = similarity
            resume.duplicate_resume_id = duplicate_id
        else:
            resume.duplicate_status = None
            resume.duplicate_similarity = similarity if similarity > 0 else None
            resume.duplicate_resume_id = None
        
        resume.parse_status = 'success'
        resume.parse_time = datetime.now()
        db.commit()
        
    except Exception as e:
        resume.parse_status = 'failed'
        resume.error_message = str(e)
        db.commit()
        print(f"处理简历失败: {e}")
    finally:
        db.close()

@app.route('/')
def index():
    """首页"""
    return render_template('index.html')

@app.route('/api/upload', methods=['POST'])
def upload_file():
    """文件上传接口（支持多文件上传）"""
    if 'file' not in request.files:
        return jsonify({'success': False, 'message': '没有文件'}), 400
    
    # 获取所